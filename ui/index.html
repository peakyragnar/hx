<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="heretix-api-base" content="https://api.heretix.ai" />
  <title>Heretix · Understand the AI answering your questions</title>
  <style>
    :root {
      --bg: #070807;
      --card: rgba(255,255,255,0.03);
      --border: rgba(0,255,65,0.25);
      --fg: #d8f7d8;
      --muted: #8ea88e;
      --bright: #00ff41;
      --accent: #ff4d4d;
      --shadow: 0 0 32px rgba(0,255,65,0.15);
    }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--fg); font-family:"Inter", "Helvetica Neue", Arial, sans-serif; }
    a { color:var(--bright); text-decoration:none; }
    header { position:sticky; top:0; backdrop-filter:blur(12px); background:rgba(7,8,7,0.9); border-bottom:1px solid rgba(0,255,65,0.15); z-index:20; }
    .nav { max-width:1100px; margin:0 auto; padding:14px 20px; display:flex; align-items:center; justify-content:space-between; position:relative; }
    .brand { font-family:"Space Mono", monospace; font-size:22px; letter-spacing:4px; color:var(--bright); text-shadow:0 0 16px rgba(0,255,65,0.35); }
    nav ul { list-style:none; display:flex; gap:18px; margin:0; padding:0; }
    nav a { font-size:14px; color:var(--muted); transition:color 0.2s ease; }
    nav a:hover { color:var(--bright); }
    .nav a.signed-in { color:var(--bright); font-weight:500; }

    /* Mobile menu button */
    .menu-btn { display:none; background:transparent; color:var(--bright); border:1px solid rgba(0,255,65,0.35); padding:6px 10px; border-radius:10px; font-size:18px; line-height:1; cursor:pointer; }

    main { max-width:1100px; margin:0 auto; padding:40px 20px 120px; }
    section { margin-top:80px; }

    body.results-mode .hero,
    body.results-mode .how,
    body.results-mode .example-section,
    body.results-mode .faq {
      display:none;
    }

    .hero { margin-top:40px; display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:40px; align-items:center; }
    .hero h1 { font-size:clamp(32px, 4.6vw, 54px); margin:0 0 12px; text-shadow:0 0 22px rgba(0,255,65,0.25); }
    .hero p { margin:0 0 24px; color:var(--muted); font-size:18px; line-height:1.5; }
    .hero .form-card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:24px; box-shadow:var(--shadow); }
    label { display:block; font-size:14px; color:var(--muted); margin-bottom:8px; text-transform:uppercase; letter-spacing:1px; }
    textarea { width:100%; border-radius:12px; border:1px solid rgba(0,255,65,0.35); background:#0b0d0b; color:var(--fg); padding:18px; font-size:17px; line-height:1.5; min-height:150px; resize:none; }
    textarea::placeholder{ color:rgba(191,214,191,0.6); }
    .form-meta { display:flex; gap:12px; flex-wrap:wrap; margin-top:16px; }
    .model-select { display:flex; flex-direction:column; border:1px solid var(--border); border-radius:12px; padding:12px; min-width:260px; }
    .model-select legend { font-size:12px; text-transform:uppercase; letter-spacing:1px; color:var(--muted); margin-bottom:8px; }
    .model-option { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:6px 0; font-size:14px; color:var(--fg); }
    .model-option input { accent-color:var(--bright); }
    .model-name { font-weight:600; }
    .model-note { font-size:12px; color:var(--muted); }
    select { flex:1; min-width:150px; border-radius:10px; padding:12px; border:1px solid rgba(0,255,65,0.35); background:#0b0d0b; color:var(--fg); font-size:15px; }
    .primary { margin-top:20px; width:100%; padding:16px; font-size:17px; font-weight:600; border-radius:12px; border:0; background:var(--bright); color:#041105; cursor:pointer; box-shadow:0 16px 40px rgba(0,255,65,0.15); transition:transform 0.2s ease, box-shadow 0.2s ease; }
    .primary:hover { transform:translateY(-2px); box-shadow:0 18px 46px rgba(0,255,65,0.25); }
    .footnote { margin-top:12px; font-size:13px; color:var(--muted); text-align:center; }
    .footnote .full-link { display:none; }

    .hidden { display:none !important; }
    .status-message { min-height:18px; transition:color 0.2s ease; }
    .status--info { color:var(--muted); }
    .status--warn { color:#ffd166; }
    .status--error { color:var(--accent); }

    .usage-meter { margin-top:10px; padding:10px 12px; border-radius:10px; border:1px solid rgba(0,255,65,0.35); background:rgba(0,255,65,0.05); font-size:13px; text-align:center; }

    .results-multi { margin-top:80px; }
    .results-multi.hidden { display:none !important; }
    .results-hero { padding:28px; border-radius:20px; border:1px solid var(--border); background:radial-gradient(circle at top, rgba(0,255,65,0.15), rgba(0,0,0,0.75)); box-shadow:0 0 42px rgba(0,255,65,0.18); }
    .results-hero-label { text-transform:uppercase; font-size:13px; letter-spacing:2px; color:var(--muted); margin:0 0 8px; }
    .results-hero h2 { margin:0; font-size:clamp(28px,5vw,42px); line-height:1.3; }
    .results-note { margin:14px 0 0; color:var(--muted); font-size:15px; }
    .results-card-grid { margin-top:36px; display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:24px; }
    .result-card { border:1px solid rgba(0,255,65,0.25); border-radius:18px; padding:24px; background:var(--card); box-shadow:0 0 32px rgba(0,0,0,0.35); display:flex; flex-direction:column; gap:16px; }
    .card-pill { display:inline-flex; align-items:center; padding:6px 12px; border-radius:999px; border:1px solid rgba(0,255,65,0.35); font-size:12px; text-transform:uppercase; letter-spacing:1px; color:var(--bright); background:rgba(0,255,65,0.08); }
    .card-percent { font-size:clamp(48px,6vw,72px); font-weight:700; color:var(--bright); text-shadow:0 0 26px rgba(0,255,65,0.35); line-height:1; }
    .card-verdict { font-size:16px; text-transform:uppercase; letter-spacing:2px; color:var(--muted); }
    .card-summary { margin:0; font-size:16px; line-height:1.6; color:var(--fg); }
    .card-lines { margin:0; padding-left:20px; color:var(--muted); line-height:1.5; }
    .card-lines li { margin-bottom:6px; }
    .resolved-note { border:1px solid rgba(0,255,65,0.4); border-radius:14px; padding:12px 16px; background:rgba(0,255,65,0.12); font-size:14px; }
    .resolved-note.false { border-color:#ff6b6b; background:rgba(255,107,107,0.12); }
    .card-details { border:1px solid rgba(0,255,65,0.2); border-radius:14px; padding:16px 18px; background:rgba(0,0,0,0.35); }
    .card-details summary { cursor:pointer; font-weight:600; color:var(--fg); }
    .metric-grid { margin-top:14px; display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px; }
    .metric-label { font-size:12px; text-transform:uppercase; letter-spacing:1px; color:rgba(0,255,65,0.7); }
    .metric-value { font-size:18px; color:var(--fg); }
    .card-copy { align-self:flex-start; }
    .result-actions { margin-top:32px; display:flex; flex-wrap:wrap; gap:16px; }
    .result-actions { margin-top:32px; display:flex; flex-wrap:wrap; gap:16px; }
    .btn { display:inline-flex; align-items:center; justify-content:center; padding:14px 22px; border-radius:14px; font-weight:600; border:0; cursor:pointer; transition:transform 0.2s ease, box-shadow 0.2s ease; }
    .btn-primary { background:var(--bright); color:#041105; box-shadow:0 16px 32px rgba(0,255,65,0.18); }
    .btn-primary:hover { transform:translateY(-2px); box-shadow:0 20px 36px rgba(0,255,65,0.28); }
    .btn-secondary { background:rgba(255,255,255,0.08); color:var(--fg); border:1px solid rgba(0,255,65,0.2); }
    .btn-secondary:hover { transform:translateY(-2px); border-color:rgba(0,255,65,0.4); }
    body.results-mode footer { margin-top:40px; }
    .loading-overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(6,8,7,0.9); backdrop-filter:blur(12px); z-index:1000; padding:24px; }
    .loading-content { text-align:center; max-width:520px; color:var(--muted); }
    .loading-content h2 { margin:0 0 16px; font-size:24px; color:var(--bright); }
    .loading-claim { font-size:18px; color:var(--fg); margin-bottom:18px; }
    .loading-steps { list-style:none; margin:0 auto 24px; padding:0; max-width:340px; text-align:left; }
    .loading-steps li { padding:12px 16px; border-radius:12px; border:1px solid rgba(0,255,65,0.2); background:rgba(0,255,65,0.04); margin-bottom:10px; font-size:14px; color:var(--muted); position:relative; overflow:hidden; }
    .loading-steps li::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:rgba(0,255,65,0.4); opacity:0; transition:opacity 0.3s ease; }
    .loading-steps li.active::before { opacity:1; }
    .loading-hero { width:340px; height:340px; margin:28px auto; position:relative; background:url('/assets/running_bg.png') center/cover no-repeat; border-radius:14px; box-shadow:0 0 36px rgba(0,255,65,0.25) inset, 0 0 24px rgba(0,255,65,0.25); }
    .loading-mask { position:absolute; left:50%; top:48%; width:120px; height:120px; transform:translate(-50%,-50%); background:radial-gradient(circle at center, rgba(6,6,6,0.85) 0%, rgba(6,6,6,0.1) 70%, rgba(6,6,6,0) 100%); border-radius:50%; pointer-events:none; }
    .loading-pill { position:absolute; left:50%; top:48%; width:56px; height:20px; transform:translate(-50%,-50%); background:#ff2b2b; border-radius:999px; border:1px solid #ff6b6b; box-shadow:0 0 18px rgba(255,0,0,0.5); animation: spin-pill 1.6s linear infinite; }
    .loading-note { margin-top:14px; color:var(--muted); font-size:14px; }
    @keyframes spin-pill { from { transform:translate(-50%,-50%) rotate(0deg); } to { transform:translate(-50%,-50%) rotate(360deg); } }

    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:100; }
    .modal.is-open { display:flex; }
    .modal-backdrop { position:absolute; inset:0; background:rgba(0,0,0,0.6); }
    .modal-dialog { position:relative; z-index:1; width:min(420px, 90vw); background:#0a0d0a; border:1px solid rgba(0,255,65,0.25); border-radius:16px; padding:28px; box-shadow:0 0 32px rgba(0,255,65,0.2); }
    .modal-dialog h2 { margin:0 0 12px; font-size:24px; }
    .modal-dialog p { color:var(--muted); font-size:14px; line-height:1.5; }
    .modal-dialog form { margin-top:16px; display:grid; gap:12px; }
    .modal-dialog input[type="email"] { padding:12px; border-radius:10px; border:1px solid rgba(0,255,65,0.35); background:#0b0d0b; color:var(--fg); }
    .modal-dialog button[type="submit"], .modal-dialog button.plan-button { padding:12px 16px; border-radius:10px; border:0; background:var(--bright); color:#041105; font-weight:600; cursor:pointer; }
    .modal-dialog button.plan-button.plan-button--secondary { background:rgba(0,255,65,0.1); color:var(--bright); border:1px solid rgba(0,255,65,0.35); width:100%; margin-top:16px; }
    .modal-dialog button[disabled] { opacity:0.6; cursor:not-allowed; }
    .modal-close { position:absolute; top:12px; right:12px; border:0; background:transparent; color:var(--muted); font-size:24px; cursor:pointer; }
    .modal-status { margin-top:14px; font-size:13px; color:var(--muted); }
    .modal-status--error { color:var(--accent); }

    .plan-grid { display:grid; gap:18px; margin-top:18px; }
    .plan-card { border:1px solid rgba(0,255,65,0.25); border-radius:14px; padding:18px; background:rgba(0,255,65,0.05); }
    .plan-card.is-current { border-color:var(--bright); box-shadow:0 0 24px rgba(0,255,65,0.2); }
    .plan-card h3 { margin:0 0 6px; font-size:18px; }
    .plan-card .price { font-size:16px; font-weight:500; margin-bottom:6px; }
    .plan-card p { font-size:14px; color:var(--muted); margin-bottom:12px; }
    .plan-card button { width:100%; }

    body.modal-open { overflow:hidden; }

    .hero-examples { display:flex; gap:10px; flex-wrap:wrap; }
    .example-pill { background:rgba(0,255,65,0.08); color:var(--bright); border:1px solid rgba(0,255,65,0.3); border-radius:24px; padding:8px 14px; font-size:13px; cursor:pointer; transition:background 0.2s ease; }
    .example-pill:hover { background:rgba(0,255,65,0.16); }

    .how { text-align:center; }
    .how h2 { font-size:28px; margin:0 0 12px; }
    .how p { color:var(--muted); max-width:640px; margin:0 auto 32px; line-height:1.6; }
    .how-grid { display:grid; gap:22px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }
    .how-card { padding:24px; border-radius:14px; border:1px solid rgba(0,255,65,0.2); background:rgba(255,255,255,0.02); box-shadow:0 0 20px rgba(0,255,65,0.08); text-align:left; }
    .how-card span { display:block; font-size:16px; letter-spacing:2px; text-transform:uppercase; color:var(--bright); font-weight:700; margin-bottom:10px; text-shadow:0 0 10px rgba(0,255,65,0.25); }
    .how-card h3 { display:none; }
    .how-card p { margin:0; color:var(--muted); line-height:1.6; }

    .example-section { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:40px; align-items:center; }
    .example-card { border-radius:18px; border:1px solid rgba(0,255,65,0.35); padding:32px; background:radial-gradient(circle at top,#112311 0%, #080c08 65%); box-shadow:0 0 36px rgba(0,255,65,0.24); }
    .example-card h3 { margin:0; font-size:52px; color:var(--bright); text-shadow:0 0 28px rgba(0,255,65,0.35); }
    .example-card small { display:block; letter-spacing:3px; font-size:12px; color:rgba(0,255,65,0.7); margin-top:6px; text-transform:uppercase; }
    .example-card .claim { font-family:"Space Mono", monospace; margin-top:18px; font-size:16px; line-height:1.6; }
    .example-card ul { margin:18px 0 0; padding-left:22px; color:var(--muted); }

    .faq { max-width:800px; margin:0 auto; }
    .faq h2 { text-align:center; margin-bottom:20px; font-size:28px; }
    details { border:1px solid rgba(0,255,65,0.25); border-radius:12px; padding:18px 20px; margin-bottom:16px; background:rgba(255,255,255,0.02); }
    summary { cursor:pointer; font-weight:600; font-size:16px; }
    summary::-webkit-details-marker { display:none; }
    details[open] summary { color:var(--bright); }
    details p { margin:12px 0 0; color:var(--muted); line-height:1.6; }

    footer { margin-top:90px; padding:30px 0; border-top:1px solid rgba(0,255,65,0.1); color:var(--muted); font-size:13px; text-align:center; }
    footer a { color:var(--muted); margin:0 12px; }
    footer a:hover { color:var(--bright); }

    @media (max-width:720px){
      .menu-btn { display:inline-block; }
      nav ul { display:none; position:absolute; right:20px; top:60px; background:#0b0d0b; border:1px solid rgba(0,255,65,0.35); border-radius:12px; padding:12px; flex-direction:column; gap:12px; min-width:200px; box-shadow:0 16px 40px rgba(0,255,65,0.15); z-index:30; }
      nav ul.open { display:flex; }
      .hero { margin-top:20px; }
      .example-card h3 { font-size:44px; }
    }
  
    body.quick main > section:not(.hero){ display:none; }
    body.quick header nav{ display:none; }
    body.quick .hero { margin-top:80px; }
    body.quick .hero > div:first-child { display:none; }
    body.quick .hero .form-card { margin:0 auto; max-width:520px; }
    body.quick .footnote .full-link { display:inline; }
  </style>
</head>
<body>
  <div class="loading-overlay hidden" id="loading-overlay" aria-live="polite">
    <div class="loading-content">
      <h2 id="loading-headline">Measuring how GPT‑5’s training data anchors this claim…</h2>
      <div class="loading-claim" id="loading-claim"></div>
      <ol class="loading-steps">
        <li class="active" id="loading-step-1">Planning the different phrasings.</li>
        <li id="loading-step-2">Asking GPT‑5 with internal knowledge only.</li>
        <li id="loading-step-3">Preparing the explanation for the verdict.</li>
      </ol>
      <div class="loading-hero">
        <div class="loading-mask"></div>
        <div class="loading-pill" aria-label="Animated red pill"></div>
      </div>
      <p class="loading-note">This usually takes less than a minute.</p>
    </div>
  </div>
  <header>
    <div class="nav">
      <a class="brand" href="/">HERETIX</a>
      <button class="menu-btn" id="nav-toggle" aria-label="Open menu" aria-expanded="false" aria-controls="nav-list">☰</button>
      <nav>
        <ul id="nav-list">
          <li><a href="/how.html">How it works</a></li>
          <li><a href="/examples.html">Examples</a></li>
          <li><a href="#" id="nav-plan-link">Plans</a></li>
          <li><a href="#" id="nav-signin">Sign up / Sign in</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <section class="hero" id="top">
      <div>
        <h1>Understand the AI answering your questions.</h1>
        <p>Heretix shows how likely the AI thinks your claim is true—and explains why.</p>
        <div class="hero-examples">
          <button type="button" class="example-pill" data-example="Do tariffs cause inflation?">Do tariffs cause inflation?</button>
          <button type="button" class="example-pill" data-example="Solar panels never pay for themselves">Do solar panels pay for themselves?</button>
          <button type="button" class="example-pill" data-example="Evidence that interest rates will never rise again">Will interest rates stay low forever?</button>
        </div>
      </div>
      <div class="form-card">
        <form id="claim-form" action="/run" method="post">
          <label for="claim">Check a claim</label>
          <textarea id="claim" name="claim" maxlength="180" placeholder="Type the claim you want to inspect." required></textarea>
          <div class="form-meta">
            <fieldset class="model-select">
              <legend>Select models</legend>
              <label class="model-option">
                <input type="checkbox" name="ui_model" value="gpt-5" checked>
                <span class="model-name">GPT‑5</span>
                <span class="model-note">OpenAI</span>
              </label>
              <label class="model-option">
                <input type="checkbox" name="ui_model" value="grok-4">
                <span class="model-name">Grok 4</span>
                <span class="model-note">xAI</span>
              </label>
              <label class="model-option">
                <input type="checkbox" name="ui_model" value="gemini-2.5">
                <span class="model-name">Gemini 2.5</span>
                <span class="model-note">Google</span>
              </label>
            </fieldset>
            <select name="ui_mode" aria-label="Mode selection">
              <option value="prior" selected>Internal knowledge only</option>
              <option value="internet-search">Internet search</option>
              <option value="user-data" disabled>User evidence · coming soon</option>
            </select>
          </div>
          <div id="usage-meter" class="usage-meter hidden" aria-live="polite"></div>
          <button class="primary" type="submit">Ask the model</button>
          <div class="footnote status-message status--info"></div>
        </form>
      </div>
    </section>

    <section id="results-multi" class="results-multi hidden" aria-live="polite">
      <div class="results-hero">
        <p class="results-hero-label">Claim evaluated</p>
        <h2 id="results-claim">“—”</h2>
        <p class="results-note" id="results-note"></p>
      </div>
      <div class="results-card-grid" id="results-card-grid"></div>
      <div class="result-actions">
        <button type="button" class="btn btn-primary" id="results-new">Ask another claim</button>
      </div>
    </section>

    <section class="how" id="how">
      <h2>How Heretix works</h2>
      <p>Heretix isolates what an AI really believes. We ask your claim in precise ways, measure how confident the model is, and explain what shaped its answer.</p>
      <div class="how-grid">
        <div class="how-card">
          <span>Step 1 — Ask</span>
          <h3>Ask</h3>
          <p>Type any claim.</p>
        </div>
        <div class="how-card">
          <span>Step 2 — Choose a model</span>
          <h3>Choose a model</h3>
          <p>Pick which AI model you want to examine as each has its own perspective and training.</p>
        </div>
        <div class="how-card">
          <span>Step 3 — Add context</span>
          <h3>Add context</h3>
          <p>Decide whether to keep the model in its own world, or let it pull from the internet for new evidence.</p>
        </div>
        <div class="how-card">
          <span>Step 4 — Understand</span>
          <h3>Understand</h3>
          <p>See how confident the model is in your claim. Inspect the explanation to further understand how the answer was derived.</p>
        </div>
      </div>
    </section>

    <section class="example-section" id="examples">
      <div class="example-card">
        <small>Example outcome</small>
        <h3>67.8%</h3>
        <div class="claim">“Do tariffs cause inflation?”</div>
        <ul>
          <li>Tariffs raise costs of imported goods for businesses and consumers.</li>
          <li>Higher import costs often pass through to prices when demand stays strong.</li>
          <li>Exceptions happen when currency shifts or suppliers absorb the tariff shock.</li>
        </ul>
      </div>
      <div>
        <h2>Ask the AI what it really believes</h2>
        <p>Heretix makes bias visible.  Input a claim (maximum 180 characters) and see what the model thinks, how confident the model is in the answer, and what items supported its conclusion</p>
        <a class="example-pill" href="#top">Start a claim</a>
      </div>
    </section>

    <section class="faq" id="faq">
      <h2>Questions people ask</h2>
      <details>
        <summary>What does the percentage mean?</summary>
        <p>This is how confident the AI is in your claim. It’s not absolute truth, it’s a reflection of what the model believes, shaped by its training and bias.</p>
      </details>
      <details>
        <summary>Does Heretix browse the web with my claim?</summary>
        <p>Your choice. Select "Internet Search" to let the model pull current information from the web to supplement its reasoning. If you only want to see the output of the model's internal training, select "Internal Knowledge Only".</p>
      </details>
      <details>
        <summary>Is this politically biased?</summary>
        <p>We show the model’s belief, not a judgement from us. Heretix reveals consensus the AI already absorbed, so you can inspect it and judge for yourself</p>
      </details>
      
    </section>
  </main>

  <footer>
    <span>© <span id="year"></span> Heretix</span>
    <a href="mailto:hello@heretix.ai">Contact</a>
    <a href="/privacy/">Privacy Policy</a>
    <a href="/terms/">Terms of Service</a>
  </footer>

  <div class="modal" id="signin-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-backdrop" data-close-modal></div>
    <div class="modal-dialog">
      <button class="modal-close" type="button" data-close-modal aria-label="Close">×</button>
      <h2>Create or access your account</h2>
      <p>Enter your email and we’ll send a magic link—first-time visitors become members instantly, no passwords required.</p>
      <form id="signin-form">
        <label for="signin-email">Email</label>
        <input type="email" id="signin-email" name="email" placeholder="you@example.com" required />
        <button type="submit">Send magic link</button>
      </form>
      <p class="modal-status" id="signin-status"></p>
    </div>
  </div>

  <div class="modal" id="plan-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-backdrop" data-close-modal></div>
    <div class="modal-dialog">
      <button class="modal-close" type="button" data-close-modal aria-label="Close">×</button>
      <h2>Choose a plan</h2>
      <p>Upgrade to keep running new claims. You can change or cancel anytime.</p>
      <div class="plan-grid">
        <div class="plan-card" data-plan-card="starter">
          <h3>Starter</h3>
          <p class="price">$5 / month</p>
          <p>20 checks per month · best for casual use</p>
          <button class="plan-button" type="button" data-plan="starter">Continue</button>
        </div>
        <div class="plan-card" data-plan-card="core">
          <h3>Core</h3>
          <p class="price">$19 / month</p>
          <p>100 checks per month · great for teams</p>
          <button class="plan-button" type="button" data-plan="core">Continue</button>
        </div>
        <div class="plan-card" data-plan-card="pro">
          <h3>Unlimited</h3>
          <p class="price">$49 / month</p>
          <p>750 checks per month · high-volume workflows</p>
          <button class="plan-button" type="button" data-plan="pro">Continue</button>
        </div>
      </div>
      <button class="plan-button plan-button--secondary hidden" type="button" id="manage-plan">Manage current subscription</button>
      <p class="modal-status" id="plan-status"></p>
    </div>
  </div>

  <script>
    (function(){
      var params = new URLSearchParams(window.location.search);
      if (params.get('plans') === '1' && !document.body.classList.contains('modal-open')) {
        setTimeout(function(){ openPlanModal(normalizePlanName(latestPlanName)); }, 0);
      }
      if (params.get('signin') === '1' && !document.body.classList.contains('modal-open')) {
        var signInModalEl = document.getElementById('signin-modal');
        if (signInModalEl) {
          setTimeout(function(){ openModal(signInModalEl); }, 0);
        }
      }
      if (params.get('quick') === '1') {
        document.body.classList.add('quick');
        var quickClaim = document.getElementById('claim');
        if (quickClaim) { quickClaim.focus(); }
      }

      var magicSignedIn = params.get('signed') === '1';

      var isLocalHarness = Boolean(window.HERETIX_UI_LOCAL);
      var meta = document.querySelector('meta[name="heretix-api-base"]');
      var apiBase = isLocalHarness ? null : (window.HERETIX_API_BASE || (meta && meta.content) || (function(){
        if (location.origin.includes('app.')) {
          return location.origin.replace('app.', 'api.');
        }
        if (location.hostname.endsWith('heretix.ai')) {
          return 'https://api.heretix.ai';
        }
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
          return 'http://127.0.0.1:8000';
        }
        return 'https://heretix-api.onrender.com';
      })());

      var claimForm = document.getElementById('claim-form');
      var claimInput = document.getElementById('claim');
      var submitBtn = claimForm ? claimForm.querySelector('button.primary') : null;
      var modeSelect = claimForm ? claimForm.querySelector('select[name="ui_mode"]') : null;
      var statusEl = claimForm ? claimForm.querySelector('.footnote') : null;
      var usageEl = document.getElementById('usage-meter');
      var loadingOverlay = document.getElementById('loading-overlay');
      var loadingClaim = document.getElementById('loading-claim');
      var loadingHeadline = document.getElementById('loading-headline');
      var loadingStep2 = document.getElementById('loading-step-2');
      var loadingStep3 = document.getElementById('loading-step-3');
      var resultsSection = document.getElementById('results-multi');
      var resultsClaim = document.getElementById('results-claim');
      var resultsNote = document.getElementById('results-note');
      var resultsGrid = document.getElementById('results-card-grid');
      var resultsNewButton = document.getElementById('results-new');

      var signInModal = document.getElementById('signin-modal');
      var signInForm = document.getElementById('signin-form');
      var signInStatus = document.getElementById('signin-status');
      var planModal = document.getElementById('plan-modal');
      var planStatus = document.getElementById('plan-status');
      var managePlanBtn = document.getElementById('manage-plan');
      var navPlanLink = document.getElementById('nav-plan-link');
      var navSignIn = document.getElementById('nav-signin');
      var meState = null; // last known account/usage state from /api/me
      var navToggle = document.getElementById('nav-toggle');
      var navList = document.getElementById('nav-list');
      if (navToggle && navList) {
        navToggle.addEventListener('click', function(evt){
          evt.preventDefault();
          var isOpen = navList.classList.toggle('open');
          navToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        });
        document.addEventListener('click', function(evt){
          if (!navList.contains(evt.target) && !navToggle.contains(evt.target)) {
            if (navList.classList.contains('open')) {
              navList.classList.remove('open');
              navToggle.setAttribute('aria-expanded', 'false');
            }
          }
        });
      }
      var currentUserEmail = '';
      var latestPlanName = 'trial';
      var MODEL_MAP = {
        "gpt-5": { code: "gpt-5", label: "GPT‑5", provider: "openai", logical_model: "gpt-5" },
        "grok-4": { code: "grok-4", label: "Grok 4", provider: "xai", logical_model: "grok-4" },
        "gemini-2.5": { code: "gemini-2.5", label: "Gemini 2.5", provider: "google", logical_model: "gemini25-default" },
      };
      var MODE_LABELS = {
        "prior": "Internal knowledge only",
        "internet-search": "Internet search",
        "user-data": "User evidence"
      };

      function normalizePlanName(name) {
        if (!name) return 'starter';
        var lower = String(name).toLowerCase();
        return ['starter', 'core', 'pro'].indexOf(lower) !== -1 ? lower : 'starter';
      }

      function setStatus(message, tone) {
        if (!statusEl) return;
        tone = tone || 'info';
        statusEl.classList.remove('status--info', 'status--warn', 'status--error');
        if (!message) {
          statusEl.textContent = '';
          statusEl.classList.add('hidden');
          return;
        }
        statusEl.textContent = message;
        statusEl.classList.remove('hidden');
        statusEl.classList.add('status--' + tone);
      }

      function renderUsage(state) {
        if (!usageEl || !state) return;
        var planName = state.usage_plan || state.plan || 'trial';
        var allowed = state.checks_allowed;
        var used = state.checks_used ?? 0;
        var remaining = state.remaining;
        latestPlanName = (planName || 'trial').toLowerCase();
        var text;
        if (allowed === null || allowed === undefined) {
          text = 'Plan ' + planName + ' · Unlimited checks';
        } else {
          text = 'Plan ' + planName + ' · ' + used + ' / ' + allowed + ' used';
          if (typeof remaining === 'number') {
            text += ' · ' + remaining + ' left';
          }
        }
        usageEl.textContent = text;
        usageEl.classList.remove('hidden');
      }

      function updatePortalButton(state) {
        if (!managePlanBtn) return;
        if (isLocalHarness || !state || !state.authenticated) {
          managePlanBtn.classList.add('hidden');
          latestPlanName = 'trial';
          return;
        }
        var planName = (state.plan || state.usage_plan || '').toLowerCase();
        if (!planName || planName === 'trial') {
          managePlanBtn.classList.add('hidden');
          latestPlanName = planName || 'trial';
          return;
        }
        latestPlanName = planName;
        managePlanBtn.classList.remove('hidden');
      }

      function renderAuth(state) {
        if (!navSignIn) return;
        if (state && state.authenticated) {
          currentUserEmail = state.email || '';
          navSignIn.dataset.mode = 'signout';
          navSignIn.textContent = 'Sign out';
          navSignIn.title = currentUserEmail ? ('Signed in as ' + currentUserEmail) : 'Sign out';
          navSignIn.classList.add('signed-in');
        } else {
          currentUserEmail = '';
          navSignIn.dataset.mode = 'signin';
          navSignIn.textContent = 'Sign up / Sign in';
          navSignIn.title = '';
          navSignIn.classList.remove('signed-in');
        }
      }

      async function handleSignOut() {
        if (!apiBase) return;
        try {
          await fetch(apiBase + '/api/auth/signout', {
            method: 'POST',
            credentials: 'include'
          });
          setStatus('Signed out.', 'info');
        } catch (err) {
          console.warn('Sign out failed', err);
          setStatus('Unable to sign out right now.', 'warn');
        }
        renderAuth(null);
        fetchMe();
      }

      function closeModal(modal) {
        if (!modal) return;
        modal.classList.remove('is-open');
        modal.setAttribute('aria-hidden', 'true');
        if (!document.querySelector('.modal.is-open')) {
          document.body.classList.remove('modal-open');
        }
      }

      function openModal(modal) {
        if (!modal) return;
        modal.classList.add('is-open');
        modal.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open');
      }

      function openPlanModal(currentPlan) {
        if (!planModal) return;
        planStatus.textContent = '';
        planStatus.classList.remove('modal-status--error');
        var planKey = normalizePlanName(currentPlan);
        planModal.querySelectorAll('.plan-card').forEach(function(card){
          card.classList.toggle('is-current', card.dataset.planCard === planKey);
        });
        if (managePlanBtn && !managePlanBtn.classList.contains('hidden')) {
          var btnText = planKey !== 'starter' ? ('Manage your ' + planKey + ' subscription') : 'Manage current subscription';
          managePlanBtn.textContent = btnText;
          managePlanBtn.setAttribute('aria-label', btnText);
        }
        openModal(planModal);
      }

      document.querySelectorAll('[data-close-modal]').forEach(function(btn){
        btn.addEventListener('click', function(){
          closeModal(this.closest('.modal'));
        });
      });

      document.querySelectorAll('.modal').forEach(function(modal){
        modal.addEventListener('click', function(evt){
          if (evt.target.matches('.modal-backdrop')) {
            closeModal(modal);
          }
        });
      });

      if (isLocalHarness && navSignIn) {
        navSignIn.classList.add('hidden');
      }
      if (!isLocalHarness && navSignIn) {
        navSignIn.dataset.mode = 'signin';
        navSignIn.addEventListener('click', function(evt){
          evt.preventDefault();
          if (navSignIn.dataset.mode === 'signout') {
            handleSignOut();
          } else if (signInModal) {
            openModal(signInModal);
          }
        });
      }

      if (navPlanLink) {
        navPlanLink.addEventListener('click', function(evt){
          evt.preventDefault();
          openPlanModal(normalizePlanName(latestPlanName));
        });
      }

      document.addEventListener('keydown', function(evt){
        if (evt.key === 'Escape') {
          closeModal(document.querySelector('.modal.is-open'));
        }
      });

      function toggleLoading(show, claimText, modeValue, modelEntries) {
        if (!loadingOverlay) return;
        var mode = modeValue || (modeSelect ? modeSelect.value : 'prior');
        var isWeb = mode === 'internet-search' || mode === 'web_informed';
        var entries = Array.isArray(modelEntries) && modelEntries.length ? modelEntries : collectSelectedEntries();
        var firstLabel = entries.length ? (entries[0].label || entries[0].code || 'GPT‑5') : 'GPT‑5';
        var subjectText = entries.length === 1 ? firstLabel : 'the selected models';
        var possessiveText = entries.length === 1 ? firstLabel + '’s' : 'the selected models’';
        if (loadingHeadline) {
          loadingHeadline.textContent = isWeb
            ? "Synthesizing " + possessiveText + " web-informed view of this claim…"
            : "Measuring how " + possessiveText + " training data anchors this claim…";
        }
        if (loadingStep2) {
          loadingStep2.textContent = isWeb
            ? "Gathering and filtering fresh web snippets."
            : "Asking " + subjectText + " with internal knowledge only.";
        }
        if (loadingStep3) {
          loadingStep3.textContent = isWeb
            ? "Preparing the web-informed verdict."
            : "Preparing the explanation for the verdict.";
        }
        if (show) {
          loadingOverlay.classList.remove('hidden');
          if (loadingClaim) {
            loadingClaim.textContent = claimText ? '“' + claimText + '”' : '';
          }
        } else {
          loadingOverlay.classList.add('hidden');
          if (loadingClaim) {
            loadingClaim.textContent = '';
          }
        }
      }

      function resetResultsView() {
        document.body.classList.remove('results-mode');
        if (resultsGrid) {
          resultsGrid.innerHTML = '';
        }
        if (resultsSection) {
          resultsSection.classList.add('hidden');
        }
        if (resultsClaim) {
          resultsClaim.textContent = '“—”';
        }
        if (resultsNote) {
          resultsNote.textContent = '';
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      async function fetchMe() {
        if (!apiBase) return;
        try {
          var res = await fetch(apiBase + '/api/me', { credentials: 'include' });
          if (!res.ok) {
            meState = null;
            renderAuth(null);
            updatePortalButton(null);
            return;
          }
          var data = await res.json();
          meState = data;
          renderUsage(data);
          renderAuth(data);
          updatePortalButton(data);
        } catch (err) {
          console.warn('Unable to fetch session info', err);
          meState = null;
          renderAuth(null);
          updatePortalButton(null);
        }
      }

      async function handleCheckout(plan) {
        if (isLocalHarness || !planStatus || !apiBase) {
          if (planStatus) {
            planStatus.textContent = 'Available in hosted mode.';
            planStatus.classList.add('modal-status--error');
          }
          return;
        }
        planStatus.textContent = 'Redirecting to checkout…';
        planStatus.classList.remove('modal-status--error');
        try {
          var res = await fetch(apiBase + '/api/billing/checkout', {
            method: 'POST',
            credentials: 'include',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ plan: plan }),
          });
          if (res.status === 401) {
            closeModal(planModal);
            setStatus('Sign up or sign in to choose a plan.', 'warn');
            openModal(signInModal);
            return;
          }
          if (!res.ok) {
            var errData = await res.json().catch(function(){ return {}; });
            planStatus.textContent = errData.detail || 'Unable to create checkout session.';
            planStatus.classList.add('modal-status--error');
            return;
          }
          var payload = await res.json();
          window.location.href = payload.checkout_url;
        } catch (err) {
          planStatus.textContent = 'Unable to reach billing service.';
          planStatus.classList.add('modal-status--error');
        }
      }

      async function handleManageSubscription() {
        if (isLocalHarness || !planStatus || !apiBase) {
          if (planStatus) {
            planStatus.textContent = 'Self-service billing is only available in hosted mode.';
            planStatus.classList.add('modal-status--error');
          }
          return;
        }
        planStatus.textContent = 'Opening billing portal…';
        planStatus.classList.remove('modal-status--error');
        try {
          var res = await fetch(apiBase + '/api/billing/portal', {
            method: 'POST',
            credentials: 'include'
          });
          if (res.status === 401) {
            closeModal(planModal);
            setStatus('Sign up or sign in to manage your subscription.', 'warn');
            openModal(signInModal);
            return;
          }
          if (!res.ok) {
            var errData = await res.json().catch(function(){ return {}; });
            planStatus.textContent = errData.detail || 'Unable to open billing portal right now.';
            planStatus.classList.add('modal-status--error');
            return;
          }
          var payload = await res.json();
          window.location.href = payload.portal_url;
        } catch (err) {
          planStatus.textContent = 'Unable to reach billing service.';
          planStatus.classList.add('modal-status--error');
        }
      }

      if (!isLocalHarness && planModal) {
        planModal.querySelectorAll('[data-plan]').forEach(function(btn){
          btn.addEventListener('click', function(){
            handleCheckout(this.getAttribute('data-plan'));
          });
        });
      }

      if (!isLocalHarness && managePlanBtn) {
        managePlanBtn.addEventListener('click', handleManageSubscription);
      }

      if (!isLocalHarness && signInForm) {
        signInForm.addEventListener('submit', async function(evt){
          evt.preventDefault();
          var email = document.getElementById('signin-email').value.trim();
          if (!email) {
            signInStatus.textContent = 'Enter a valid email.';
            signInStatus.classList.add('modal-status--error');
            return;
          }
          signInStatus.textContent = 'Sending magic link…';
          signInStatus.classList.remove('modal-status--error');
          try {
            var res = await fetch(apiBase + '/api/auth/magic-links', {
              method: 'POST',
              credentials: 'include',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ email: email })
            });
            if (!res.ok) {
              var errDetail = await res.json().catch(function(){ return {}; });
              signInStatus.textContent = errDetail.detail || 'Unable to send link right now.';
              signInStatus.classList.add('modal-status--error');
              return;
            }
            signInStatus.textContent = 'Check your email to finish—your link signs you in or creates your account automatically.';
          } catch (err) {
            signInStatus.textContent = 'Unable to send link. Check your connection and retry.';
            signInStatus.classList.add('modal-status--error');
          }
        });
      }

      if (resultsNewButton) {
        resultsNewButton.addEventListener('click', function(){
          resetResultsView();
          if (claimInput) {
            claimInput.value = '';
            claimInput.focus();
          }
        });
      }

      if (resultsGrid) {
        resultsGrid.addEventListener('click', function(evt){
          var btn = evt.target.closest('.card-copy');
          if (!btn) return;
          var summary = btn.dataset.summary || '';
          copySummaryToClipboard(summary, btn);
        });
      }

      function formatPercent(value) {
        if (typeof value !== 'number' || value !== value) return '--%';
        return (value * 100).toFixed(1).replace(/\.0$/, '') + '%';
      }

      function formatNumber(value, digits) {
        if (typeof value !== 'number' || value !== value) return '--';
        var places = typeof digits === 'number' ? Math.max(0, digits) : 3;
        var fixed = value.toFixed(places);
        fixed = fixed.replace(/\.0+$/, '').replace(/(\.\d*[1-9])0+$/, '$1');
        return fixed;
      }

      function cleanLine(text) {
        if (typeof text !== 'string') return '';
        var condensed = text.replace(/\s+/g, ' ').trim();
        if (!condensed) return '';
        if (!/[.!?]$/.test(condensed)) {
          condensed += '.';
        }
        return condensed;
      }

      function collectSimpleLines(simpleBlock, runData) {
        var lines = [];
        var seen = new Set();
        function append(items) {
          if (!Array.isArray(items)) return;
          for (var i = 0; i < items.length; i++) {
            var cleaned = cleanLine(items[i]);
            if (cleaned && !seen.has(cleaned)) {
              seen.add(cleaned);
              lines.push(cleaned);
            }
            if (lines.length >= 3) return;
          }
        }
        append(simpleBlock && simpleBlock.lines);
        append(simpleBlock && simpleBlock.bullets);
        append(simpleBlock && simpleBlock.body_paragraphs);
        if (!lines.length) {
          append(runData && runData.explanation_reasons);
        }
        if (!lines.length) {
          var fallback = cleanLine(getSimpleSummary(simpleBlock, runData) || runData.explanation_text);
          if (fallback) {
            lines.push(fallback);
          }
        }
        if (!lines.length) {
          lines.push('No additional context was provided.');
        }
        var summaryClean = cleanLine(getSimpleSummary(simpleBlock, runData));
        if (summaryClean) {
          lines = lines.filter(function(item){ return item !== summaryClean; });
        }
        return lines.slice(0, 3);
      }

      function getSimpleSummary(simpleBlock, runData) {
        var summary = (simpleBlock && typeof simpleBlock.summary === 'string') ? simpleBlock.summary.trim() : '';
        if (summary) {
          return summary;
        }
        var paragraphs = simpleBlock && simpleBlock.body_paragraphs;
        if (Array.isArray(paragraphs)) {
          for (var i = 0; i < paragraphs.length; i++) {
            var para = typeof paragraphs[i] === 'string' ? paragraphs[i].trim() : '';
            if (para) {
              return para;
            }
          }
        }
        var legacy = (runData && typeof runData.explanation_headline === 'string') ? runData.explanation_headline.trim() : '';
        if (legacy) {
          return legacy;
        }
        var text = (runData && typeof runData.explanation_text === 'string') ? runData.explanation_text.trim() : '';
        return text;
      }


      function buildResultCard(runEntry, meta, modeLabel, isWebMode) {
        var card = document.createElement('article');
        card.className = 'result-card';
        var pill = document.createElement('div');
        pill.className = 'card-pill';
        pill.textContent = (meta.label || runEntry.model || 'Model') + ' · ' + modeLabel;
        card.appendChild(pill);

        var aggregates = (runEntry && typeof runEntry.aggregates === 'object') ? runEntry.aggregates : {};
        var combined = (runEntry && typeof runEntry.combined === 'object') ? runEntry.combined : {};
        var simpleBlock = (runEntry && typeof runEntry.simple_expl === 'object') ? runEntry.simple_expl : {};
        var priorBlock = (runEntry && typeof runEntry.prior === 'object') ? runEntry.prior : {};
        var webBlock = (runEntry && typeof runEntry.web === 'object') ? runEntry.web : null;
        var weightsBlock = (runEntry && typeof runEntry.weights === 'object') ? runEntry.weights : {};

        var probability = (typeof combined.p === 'number') ? combined.p : (typeof aggregates.prob_true_rpl === 'number' ? aggregates.prob_true_rpl : null);
        var percentEl = document.createElement('div');
        percentEl.className = 'card-percent';
        percentEl.textContent = formatPercent(probability);
        card.appendChild(percentEl);

        var verdictInfo = buildVerdict(probability);
        var verdictText = combined.label || runEntry.verdict_label || verdictInfo.title;
        var verdictEl = document.createElement('div');
        verdictEl.className = 'card-verdict';
        verdictEl.textContent = verdictText || '';
        card.appendChild(verdictEl);

        var summaryPara = document.createElement('p');
        summaryPara.className = 'card-summary';
        var titleText = simpleBlock.title || verdictInfo.headline;
        var summaryText = getSimpleSummary(simpleBlock, runEntry) || verdictInfo.text;
        if (titleText) {
          var strong = document.createElement('strong');
          strong.textContent = titleText;
          summaryPara.appendChild(strong);
          summaryPara.appendChild(document.createTextNode(' '));
        }
        summaryPara.appendChild(document.createTextNode(summaryText || 'This model did not return an explanation.'));
        card.appendChild(summaryPara);

        var lines = collectSimpleLines(simpleBlock, runEntry);
        if (lines.length) {
          var list = document.createElement('ul');
          list.className = 'card-lines';
          lines.forEach(function(line){
            var li = document.createElement('li');
            li.textContent = line;
            list.appendChild(li);
          });
          card.appendChild(list);
        }

        if (isWebMode && webBlock && webBlock.resolved) {
          var resolvedDiv = document.createElement('div');
          resolvedDiv.className = 'resolved-note' + (webBlock.resolved_truth === false ? ' false' : '');
          var truthLabel = 'Resolved';
          if (webBlock.resolved_truth === true) {
            truthLabel = 'Resolved true';
          } else if (webBlock.resolved_truth === false) {
            truthLabel = 'Resolved false';
          }
          var reasonText = cleanLine(webBlock.resolved_reason) || 'Resolver confirmed this verdict from web evidence.';
          resolvedDiv.textContent = truthLabel + ' · ' + reasonText;
          card.appendChild(resolvedDiv);
        }

        var details = document.createElement('details');
        details.className = 'card-details';
        var summaryEl = document.createElement('summary');
        summaryEl.textContent = 'Deeper explanation';
        details.appendChild(summaryEl);

        var ciSource = Array.isArray(combined.ci95) ? combined.ci95 : aggregates.ci95;
        var ciLo = Array.isArray(ciSource) ? ciSource[0] : null;
        var ciHi = Array.isArray(ciSource) ? ciSource[1] : null;
        var metricGrid = document.createElement('div');
        metricGrid.className = 'metric-grid';
        function addMetric(label, value) {
          var wrap = document.createElement('div');
          var lbl = document.createElement('div');
          lbl.className = 'metric-label';
          lbl.textContent = label;
          var val = document.createElement('div');
          val.className = 'metric-value';
          val.textContent = value;
          wrap.appendChild(lbl);
          wrap.appendChild(val);
          metricGrid.appendChild(wrap);
        }
        addMetric('CI 95% range', formatPercent(ciLo) + ' – ' + formatPercent(ciHi));
        addMetric('CI width', formatNumber(aggregates.ci_width));
        var stabilityText = formatNumber(aggregates.stability_score, 2);
        if (aggregates.stability_band) {
          stabilityText += ' (' + aggregates.stability_band + ')';
        }
        addMetric('Template stability', stabilityText);
        addMetric('Policy compliance', formatPercent(aggregates.rpl_compliance_rate));
        addMetric('Cache hit rate', formatPercent(aggregates.cache_hit_rate));
        details.appendChild(metricGrid);

        var priorHeading = document.createElement('h4');
        priorHeading.textContent = 'Training-only (model prior)';
        details.appendChild(priorHeading);
        var priorPara = document.createElement('p');
        var priorCi = Array.isArray(priorBlock.ci95) ? priorBlock.ci95 : [null, null];
        var priorCiText = formatPercent(priorCi[0]) + ' – ' + formatPercent(priorCi[1]);
        priorPara.textContent = 'Baseline probability ' + formatPercent(priorBlock.p) +
          ' with 95% CI ' + priorCiText + '. Template stability score ' + formatNumber(priorBlock.stability, 2) + '.';
        details.appendChild(priorPara);

        if (isWebMode) {
          var webHeading = document.createElement('h4');
          webHeading.textContent = 'Web evidence (recent)';
          details.appendChild(webHeading);
          var webPara = document.createElement('p');
          if (webBlock) {
            var evidence = (webBlock.evidence && typeof webBlock.evidence === 'object') ? webBlock.evidence : {};
            var docs = Number(evidence.n_docs || 0);
            var domains = Number(evidence.n_domains || 0);
            var medianAge = evidence.median_age_days;
            var recencyText = (typeof medianAge === 'number' && medianAge === medianAge)
              ? 'median age ≈ ' + Math.round(medianAge) + ' days'
              : 'fresh sources';
            webPara.textContent = docs + ' doc' + (docs === 1 ? '' : 's') + ' across ' + domains + ' domain' + (domains === 1 ? '' : 's') +
              ', ' + recencyText + '. The web resolver funnels only policy-compliant evidence into this verdict.';
          } else {
            webPara.textContent = 'Waiting for web results. This run retained the model prior.';
          }
          details.appendChild(webPara);
        }

        if (weightsBlock && typeof weightsBlock.w_web !== 'undefined') {
          var weightHeading = document.createElement('h4');
          weightHeading.textContent = 'How we combine';
          details.appendChild(weightHeading);
          var weightPara = document.createElement('p');
          var webWeight = Number(weightsBlock.w_web || 0);
          if (!(webWeight === webWeight)) {
            webWeight = 0;
          }
          webWeight = Math.min(1, Math.max(0, webWeight));
          var priorWeight = Math.min(1, Math.max(0, 1 - webWeight));
          weightPara.textContent = 'Current weighting: ' + formatPercent(webWeight) + ' web · ' + formatPercent(priorWeight) +
            ' prior. We default to the prior when web evidence is limited.';
          details.appendChild(weightPara);
        }

        card.appendChild(details);

        var summaryPayload = [titleText, summaryText].concat(lines).filter(Boolean).join('
');
        var copyBtn = document.createElement('button');
        copyBtn.type = 'button';
        copyBtn.className = 'btn btn-secondary card-copy';
        copyBtn.dataset.summary = summaryPayload;
        copyBtn.textContent = 'Copy summary';
        card.appendChild(copyBtn);

        return card;
      }

      function buildErrorCard(meta, errorInfo, modeLabel) {
        var card = document.createElement('article');
        card.className = 'result-card';
        var pill = document.createElement('div');
        pill.className = 'card-pill';
        pill.textContent = (meta.label || 'Model') + ' · ' + modeLabel;
        card.appendChild(pill);
        var verdictEl = document.createElement('div');
        verdictEl.className = 'card-verdict';
        verdictEl.textContent = 'Unable to complete';
        card.appendChild(verdictEl);
        var summary = document.createElement('p');
        summary.className = 'card-summary';
        summary.textContent = describeError(errorInfo);
        card.appendChild(summary);
        return card;
      }

      function renderMultiResults(claimText, modeLabel, entries, successMap, failureMap, isWebMode) {
        if (!resultsSection || !resultsGrid) return;
        resultsGrid.innerHTML = '';
        var rendered = 0;
        entries.forEach(function(entry){
          var key = entry.code;
          if (successMap.has(key)) {
            var payload = successMap.get(key);
            resultsGrid.appendChild(buildResultCard(payload.data, entry, modeLabel, isWebMode));
            rendered += 1;
          } else if (failureMap.has(key)) {
            resultsGrid.appendChild(buildErrorCard(entry, failureMap.get(key), modeLabel));
            rendered += 1;
          }
        });
        if (!rendered) {
          var empty = document.createElement('p');
          empty.className = 'card-summary';
          empty.textContent = 'No runs completed.';
          resultsGrid.appendChild(empty);
        }
        if (resultsClaim) {
          resultsClaim.textContent = claimText ? '“' + claimText + '”' : '“—”';
        }
        if (resultsNote) {
          var modelsPhrase = entries.length + ' model' + (entries.length === 1 ? '' : 's') + ' evaluated';
          resultsNote.textContent = modelsPhrase + ' · ' + modeLabel;
        }
        resultsSection.classList.remove('hidden');
        document.body.classList.add('results-mode');
        window.scrollTo({ top: resultsSection.offsetTop - 40, behavior: 'smooth' });
      }

      function renderServerCards(payload) {
        if (!resultsSection || !resultsGrid) return;
        var block = payload && typeof payload.cards_block === 'string'
          ? payload.cards_block
          : '';
        if (!block && payload && Array.isArray(payload.cards)) {
          block = payload.cards.join('');
        }
        if (block) {
          resultsGrid.innerHTML = block;
        } else {
          resultsGrid.innerHTML = '';
          var fallback = document.createElement('p');
          fallback.className = 'card-summary';
          fallback.textContent = 'No runs completed.';
          resultsGrid.appendChild(fallback);
        }
        if (resultsClaim) {
          var claimText = payload && payload.claim ? String(payload.claim) : '';
          resultsClaim.textContent = claimText ? '“' + claimText + '”' : '“—”';
        }
        if (resultsNote) {
          resultsNote.textContent = (payload && payload.model_note) || '';
        }
        resultsSection.classList.remove('hidden');
        document.body.classList.add('results-mode');
        window.scrollTo({ top: resultsSection.offsetTop - 40, behavior: 'smooth' });
      }

      function describeError(errorInfo) {
        if (!errorInfo) return 'Request failed. Please try again.';
        var detail = errorInfo.detail || {};
        var baseDetail = typeof detail === 'string' ? detail : detail.detail;
        if (errorInfo.status === 402) {
          var reason = detail.reason || (detail.detail && detail.detail.reason) || detail.detail || '';
          if (reason === 'require_signin') {
            return 'Sign in to keep using this model.';
          }
          if (reason === 'require_subscription' || reason === 'limit_reached') {
            return 'Plan limit reached. Upgrade to continue.';
          }
          return 'Usage limit reached. Try again later.';
        }
        if (errorInfo.status === 422) {
          return 'Invalid request. Check your claim and try again.';
        }
        if (errorInfo.status === 429) {
          return 'Temporarily rate-limited. Please wait and retry.';
        }
        if (baseDetail) {
          return typeof baseDetail === 'string' ? baseDetail : JSON.stringify(baseDetail);
        }
        if (errorInfo.message) {
          return errorInfo.message;
        }
        return 'Request failed (' + (errorInfo.status || 'network') + ').';
      }

      function copySummaryToClipboard(text, trigger) {
        if (!text) return;
        function markCopied() {
          if (!trigger) return;
          trigger.textContent = 'Summary copied!';
          setTimeout(function(){ trigger.textContent = 'Copy summary'; }, 2000);
        }
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(markCopied).catch(function(){
            fallbackCopyInternal(text, trigger);
          });
          return;
        }
        fallbackCopyInternal(text, trigger);
      }

      function fallbackCopyInternal(text, trigger) {
        var textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'absolute';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
        } catch (err) {}
        document.body.removeChild(textarea);
        if (trigger) {
          trigger.textContent = 'Summary copied!';
          setTimeout(function(){ trigger.textContent = 'Copy summary'; }, 2000);
        }
      }

      function collectSelectedEntries() {
        if (!claimForm) return [];
        var inputs = claimForm.querySelectorAll('input[name="ui_model"]:checked');
        var entries = [];
        inputs.forEach(function(input){
          var code = (input.value || '').trim().toLowerCase();
          var meta = MODEL_MAP[code];
          if (meta && !entries.some(function(item){ return item.code === meta.code; })) {
            entries.push(meta);
          }
        });
        return entries;
      }

      async function runModelRequest(meta, claimValue, modeNormalized, useMock) {
        var payload = {
          claim: claimValue,
          mode: modeNormalized,
          logical_model: meta.logical_model,
          provider: meta.provider,
          model: meta.logical_model,
        };
        if (useMock) {
          payload.mock = true;
        }
        var response;
        var body;
        try {
          response = await fetch(apiBase + '/api/checks/run', {
            method: 'POST',
            credentials: 'include',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify(payload),
          });
          body = await response.json().catch(function(){ return {}; });
        } catch (err) {
          err.meta = meta;
          throw err;
        }
        if (!response.ok) {
          var error = new Error('Request failed');
          error.status = response.status;
          error.detail = body;
          error.meta = meta;
          throw error;
        }
        return body;
      }

      function serializeFormParams(form) {
        var params = new URLSearchParams();
        if (!form) return params;
        var formData = new FormData(form);
        formData.forEach(function(value, key){
          if (value === undefined || value === null) {
            return;
          }
          params.append(key, value);
        });
        return params;
      }

      async function startLocalHarnessJob() {
        var params = serializeFormParams(claimForm);
        var response = await fetch('/run?format=json', {
          method: 'POST',
          headers: {
            'accept': 'application/json',
            'content-type': 'application/x-www-form-urlencoded; charset=UTF-8'
          },
          body: params.toString(),
        });
        var payload = await response.json().catch(function(){ return null; });
        if (!response.ok) {
          var detail = payload && (payload.error || payload.message);
          var error = new Error(detail || 'Unable to start the local harness.');
          error.status = response.status;
          throw error;
        }
        return payload || {};
      }

      function resolveLocalPollUrl(jobPayload) {
        if (!jobPayload) return '';
        if (jobPayload.poll_url) return jobPayload.poll_url;
        var base = jobPayload.wait_url || '';
        if (!base) return '';
        if (base.indexOf('format=') !== -1) {
          return base;
        }
        return base + (base.indexOf('?') === -1 ? '?format=json' : '&format=json');
      }

      async function fetchLocalHarnessResult(pollUrl) {
        var response = await fetch(pollUrl, {
          headers: { 'accept': 'application/json' },
        });
        var payload = await response.json().catch(function(){ return null; });
        if (!response.ok) {
          var detail = payload && (payload.error || payload.message);
          var error = new Error(detail || 'The local harness run failed.');
          error.status = response.status;
          throw error;
        }
        return payload || {};
      }

      function handleUsageErrors(errors) {
        if (!errors || !errors.length) return false;
        for (var i = 0; i < errors.length; i++) {
          var err = errors[i];
          if (!err || err.status !== 402) {
            continue;
          }
          var detail = err.detail || {};
          var reason = detail.reason || (detail.detail && detail.detail.reason) || detail.detail || '';
          if (reason === 'require_signin') {
            setStatus('Sign up or sign in to keep reading new claims.', 'warn');
            if (signInStatus) {
              signInStatus.textContent = '';
            }
            openModal(signInModal);
          } else if (reason === 'require_subscription' || reason === 'limit_reached') {
            setStatus('You’ve used your free checks—choose a plan to continue.', 'warn');
            openPlanModal(detail.plan || detail.usage_plan || 'starter');
          } else {
            setStatus('Usage limit reached. Try again later.', 'warn');
          }
          fetchMe();
          return true;
        }
        return false;
      }

      if (claimForm) {
        claimForm.addEventListener('submit', async function(evt){
          evt.preventDefault();
          if (!isLocalHarness && !apiBase) {
            setStatus('API unavailable in this environment.', 'error');
            return;
          }
          var value = (claimInput ? claimInput.value : '').trim();
          if (!value) {
            setStatus('Enter a claim to evaluate.', 'warn');
            if (claimInput) {
              claimInput.focus();
            }
            return;
          }
          if (value.length > 180) {
            setStatus('Claims are limited to 180 characters.', 'warn');
            return;
          }
          var selectedEntries = collectSelectedEntries();
          if (!selectedEntries.length) {
            setStatus('Choose at least one model to compare.', 'warn');
            return;
          }
          var modeValue = modeSelect ? modeSelect.value : 'prior';
          var modeNormalized = modeValue === 'internet-search' ? 'web_informed' : 'baseline';
          var modeLabel = MODE_LABELS[modeValue] || 'Internal knowledge only';
          var isWebMode = modeValue === 'internet-search';
          var originalBtnText = submitBtn ? submitBtn.textContent : '';
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Running…';
          }
          setStatus('Comparing ' + selectedEntries.length + ' model' + (selectedEntries.length === 1 ? '' : 's') + '…', 'info');
          toggleLoading(true, value, modeValue, selectedEntries);
          try {
            if (isLocalHarness) {
              var jobPayload = await startLocalHarnessJob();
              var pollUrl = resolveLocalPollUrl(jobPayload);
              if (!pollUrl) {
                throw new Error('Local harness did not return a wait URL.');
              }
              setStatus('Local harness is running…', 'info');
              var localResult = await fetchLocalHarnessResult(pollUrl);
              renderServerCards(localResult);
              setStatus('All set! Scroll down to compare the models.', 'info');
            } else {
              var useMock = params.get('mock') === '1';
              var runPromises = selectedEntries.map(function(entry){
                return runModelRequest(entry, value, modeNormalized, useMock).then(function(data){
                  return { meta: entry, data: data };
                });
              });
              var settled = await Promise.allSettled(runPromises);
              var successMap = new Map();
              var failureMap = new Map();
              var errorList = [];
              settled.forEach(function(result, idx){
                var entry = selectedEntries[idx];
                if (result.status === 'fulfilled') {
                  successMap.set(entry.code, result.value);
                } else {
                  var errObj = result.reason || {};
                  if (!errObj.meta) {
                    errObj.meta = entry;
                  }
                  failureMap.set(entry.code, errObj);
                  errorList.push(errObj);
                }
              });
              var handledUsage = handleUsageErrors(errorList);
              if (!successMap.size) {
                if (!handledUsage && errorList.length) {
                  setStatus(describeError(errorList[0]), 'error');
                }
                resetResultsView();
                return;
              }
              var firstSuccess = successMap.values().next().value;
              if (firstSuccess && firstSuccess.data) {
                renderUsage(firstSuccess.data);
              }
              renderMultiResults(value, modeLabel, selectedEntries, successMap, failureMap, isWebMode);
              if (failureMap.size) {
                setStatus('Finished with some issues—check the cards for details.', 'warn');
              } else {
                setStatus('All set! Scroll down to compare the models.', 'info');
              }
            }
          } catch (err) {
            console.error(err);
            if (isLocalHarness) {
              var localMessage = err && err.message ? err.message : 'Unable to finish this local run.';
              setStatus(localMessage, 'error');
            } else {
              setStatus('Unable to reach the API. Check your connection and try again.', 'error');
            }
            resetResultsView();
          } finally {
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = originalBtnText;
            }
            toggleLoading(false, null, modeValue, selectedEntries);
          }
        });
      }

      document.querySelectorAll('.example-pill').forEach(function(btn){
        btn.addEventListener('click', function(){
          if (!claimInput) return;
          var example = btn.getAttribute('data-example');
          if (example) {
            claimInput.value = example;
            claimInput.focus();
          }
        });
      });

      var yearSpan = document.getElementById('year');
      if (yearSpan) {
        yearSpan.textContent = new Date().getFullYear();
      }

      if (!isLocalHarness) {
        fetchMe();
      }
    })();

    function buildVerdict(prob) {
      var value = typeof prob === 'number' ? prob : 0.5;
      if (value >= 0.6) {
        return {
          title: 'Likely true',
          headline: 'Why it’s likely true',
          text: 'This model leans toward the claim being true based on its prior.'
        };
      }
      if (value <= 0.4) {
        return {
          title: 'Likely false',
          headline: 'Why it’s likely false',
          text: 'This model leans toward the claim being false based on its prior.'
        };
      }
      return {
        title: 'Uncertain',
        headline: 'Why it’s uncertain',
        text: 'This model did not express a strong prior either way; responses were mixed.'
      };
    }

  </script>
</body>
</html>
